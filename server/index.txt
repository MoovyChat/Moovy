https://medium.com/@doyun.kim3878/graphql-subscriptions-in-2021-the-backend-b602b1fe6e15


import 'reflect-metadata';

import { ApolloServer } from 'apollo-server-express';
import { CommentResolver } from './resolvers/comments';
import { HelloResolver } from './resolvers/hello';
import { MovieResolver } from './resolvers/movies';
import { MovieStatsResolver } from './resolvers/movieStats';
import { PlatformResolver } from './resolvers/platforms';
import { UserResolver } from './resolvers/users';
import { __prod__ } from './constants';
import { buildSchema } from 'type-graphql';
import { conn } from './dataSource';
import cors from 'cors';
import { createServer } from 'http';
import express from 'express';
import { useServer } from 'graphql-ws/lib/use/ws';
import ws from 'ws';

const PORT = 4000;
const main = async () => {
  conn
    .initialize()
    .then(async () => {
      // here you can start to work with your database
    })
    .catch((error) => console.log(error));

  const app = express();
  const server = createServer(app);
  const corsOptions = {
    origin: '*', //for now at least, for testing purposes,
  };
  app.use(cors(corsOptions));
  const schema = await buildSchema({
    resolvers: [
      HelloResolver,
      UserResolver,
      CommentResolver,
      MovieResolver,
      PlatformResolver,
      MovieStatsResolver,
    ],
  });
  const apolloServer = new ApolloServer({
    schema,
    plugins: [
      {
        async serverWillStart() {
          return {
            async drainServer() {
              wsServer.close();
            },
          };
        },
      },
    ],
  });
  await apolloServer.start();
  apolloServer.applyMiddleware({ app, cors: corsOptions });
  const wsServer = new ws.Server({
    server,
    path: '/graphql',
  });
  server.listen(PORT, () => {
    useServer({ schema }, wsServer);
    console.log('server running on port ${PORT}');
  });
};

main();
